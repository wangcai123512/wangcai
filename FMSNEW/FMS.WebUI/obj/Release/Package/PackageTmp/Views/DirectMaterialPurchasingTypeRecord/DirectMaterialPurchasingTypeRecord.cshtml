@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout_New.cshtml"; 
}
<script type="text/javascript">
    $(document).ready(function () {
        var customer;
        $.ajax({
            url: "/InternalAPI/GetCustomer",
            async: false,
            dataType: "json",
            success: function (d) {
                customer = d;
            }
        });
        var rper = GetSupplier()
        $('#customer').multiselect({
            buttonWidth: '100%',
            maxHeight: 200,
            enableFiltering: true,
            includeFilterNewBtn: false
        });
        $("#customer").multiselect('dataprovider', rper);

        $('#RPer').multiselect({
            buttonWidth: '100%',
            maxHeight: 200,
            enableFiltering: true,
            includeFilterNewBtn: false
        });
        $("#RPer").multiselect('dataprovider', rper);
        $('#RPer1').multiselect({
            buttonWidth: '100%',
            maxHeight: 200,
            enableFiltering: true,
            includeFilterNewBtn: false
        });
        $("#RPer1").multiselect('dataprovider', rper);
        $('#RPer2').multiselect({
            buttonWidth: '100%',
            maxHeight: 200,
            enableFiltering: true,
            includeFilterNewBtn: false
        });
        $("#RPer2").multiselect('dataprovider', rper);

        var currency;
        $.ajax({
            url: "/InternalAPI/GetCommonCurrency",
            async: false,
            dataType: "json",
            success: function (d) {
                currency = d;
            }
        });

        $('#Currency').multiselect({
            buttonWidth: '100%',
            maxHeight: 200,
            enableFiltering: true,
            includeFilterNewBtn: false
        });
        $("#Currency").multiselect('dataprovider', currency);
        $("#Currency").multiselect('select', standardCoin);

        $('#Currency1').multiselect({
            buttonWidth: '100%',
            maxHeight: 200,
            enableFiltering: true,
            includeFilterNewBtn: false
        });
        $("#Currency1").multiselect('dataprovider', currency);
        $("#Currency1").multiselect('select', standardCoin);

        $('#Currency2').multiselect({
            buttonWidth: '100%',
            maxHeight: 200,
            enableFiltering: true,
            includeFilterNewBtn: false
        });
        $("#Currency2").multiselect('dataprovider', currency);
        $("#Currency2").multiselect('select', standardCoin);

        $('#customer').multiselect({
            buttonWidth: '100%',
            maxHeight: 200,
            enableFiltering: false,
            includeFilterNewBtn: false,
            includeSelectAllOption: true
        });
        $('#state').multiselect({
            buttonWidth: '100%',
            maxHeight: 200,
            enableFiltering: false,
            includeFilterNewBtn: false,
            includeSelectAllOption: true
        });
        $('#incomeGrp').multiselect({
            buttonWidth: '100%',
            maxHeight: 200,
            enableFiltering: false,
            includeFilterNewBtn: false,
            includeSelectAllOption: true
        });
        $('#InvType').multiselect({
            buttonWidth: '100%',
            maxHeight: 200,
            enableFiltering: false,
            includeFilterNewBtn: false,
            includeSelectAllOption: true
        });
        $('#TaxationType').multiselect({
            buttonWidth: '100%',
            maxHeight: 200,
            enableFiltering: false,
            includeFilterNewBtn: false,
            includeSelectAllOption: true
        });

    });
</script>
<div id="main" style="margin-top: 100px;">
    <aside id="sidebar_left" style="font-size: 16px;">
        <div class="sidebar-menu" style="margin-top: 10px">
             <ul class="nav" style="">
                <li> <a onclick="javascript:window.location = '/DirectMaterialPurchasingRecord/Index'" href="javascript:window.location = '/DirectMaterialPurchasingRecord/Index'"><span class="glyphicons glyphicons-chevron-right" style="font-size: 14px"></span> <span class="sidebar-title" style="font-size: 14px">物料与资产</span></a> </li>
                                <li> <a onclick="javascript:window.location = '/DirectMaterialPurchasingTypeRecord/Index'" href="javascript:window.location='/DirectMaterialPurchasingTypeRecord/Index'"><span class="glyphicons glyphicons-chevron-right" style="font-size: 14px"></span><span class="sidebar-title" style="font-size: 14px">物料与资产类别设置</span></a> </li>
                 <li class="active"> <a onclick="javascript:window.location = '/DirectMaterialPurchasingQuery/Index'" href="javascript:window.location = '/DirectMaterialPurchasingQuery/Index'"><span class="glyphicons glyphicons-chevron-right" style="font-size: 14px"></span><span class="sidebar-title" style="font-size: 14px">直接物料查询与处置</span><span class="sidebar-title-tray"></span></a> </li>
                <li> <a onclick="javascript:window.location = '/IndirectMaterialPurchasingQuery/Index'" href="javascript:window.location='/IndirectMaterialPurchasingQuery/Index'"><span class="glyphicons glyphicons-chevron-right" style="font-size: 14px"></span><span class="sidebar-title" style="font-size: 14px">间接物料查询与处置</span></a> </li>
                <li> <a onclick="javascript:window.location = '/AssetPurchaseQuery/Index'" href="javascript:window.location='/AssetPurchaseQuery/Index'"><span class="glyphicons glyphicons-chevron-right" style="font-size: 14px"></span><span class="sidebar-title" style="font-size: 14px">资产查询与处置</span></a> </li>
                <li> <a onclick="javascript:window.location = '/IncomeRecord/Temporary'" href="javascript:window.location = '/IncomeRecord/Temporary'"><span class="glyphicons glyphicons-chevron-right" style="font-size: 14px"></span><span class="sidebar-title" style="font-size: 14px">寻求会计帮助</span></a></li>
            </ul>
        </div>
    </aside>
    <!-- Start: Content -->
    <section id="content_wrapper">
    <div id="MAIN" style="background-color: #FFF" >
    <div id="content">
        <div class="row" style="margin-top: 20px;">
        <div class="col-md-12" style="margin-bottom: 20px; text-align: center"><span style="font-size: 30px; font-weight: 900; color: #074592; text-decoration: underline">直接物料类别设置</span></div>
           
            <div class="col-md-12"> 
                       
                        <div class="col-md-2">
                            <div class="form-group">
                                <a onclick="ShowAddCategory()" style="width: 100%; border: 2px solid #000000; border-radius: 100px; font-size: 14px; color: #000000;" class="zocial">新建类别</a>
                            </div>
                        </div> 
                        <div class="col-md-2">
                            <div class="form-group">
                                <a onclick="ShowAddSubCategory()" style="width: 100%; border: 2px solid #000000; border-radius: 100px; font-size: 14px; color: #000000;" class="zocial">新建子类别</a>
                            </div>
                        </div>                           
                    </div>        
             <div class="col-md-12" style="margin: auto">
                <div class="panel panel-visible">
                    <div class="panel-body pbn">
                        <div id="toolbar">
                            <div class="col-md-12" style="margin-bottom: 0px">
                              
                            </div>
                        </div>
                        <table id="dataList" style="font-size: 12px">
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
    </section>
</div>

<div class="modal fade" id="ShowAddCategory" tabindex="-1" role="dialog" aria-labelledby="ShowAddCategory"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="ShowAddCategory">
                    新增类别
                </h4>
            </div>
            <div class="modal-body"> 
                <div class="row">
                    <div class="col-md-12" style="margin-bottom: 0px">
                             <form id="Add_Form" style="text-align: center;">
                                <div class="form-group">
                                    <div class="input-group " style="margin: 0">
                                        <span class="input-group-addon" style="color: #000000">&nbsp;&nbsp;类别名称&nbsp;&nbsp;&nbsp;</span>
                                        <input type="text" id="CategoryName" name="CategoryName" class="form-control" required=""/>
                                    </div>
                                </div>
                                <div class="form-group" style="margin: auto; text-align: center">
                                    <div class="col-md-12" style="margin: auto">
                                        <button type="button" id="btn1" onclick="Submit()" style="text-align: center; margin-top: 0px;
                                            height: 30px; width: 20%; border-radius: 100px; font-size: 12px; background-color: #f5f5f5;
                                            border: 2px solid #c0c0c0; font-weight: bold" class="btn btn-default">
                                            提交</button>
                                    </div>
                                </div>
                                <br />
                                <br />                         
                                <div class="form-group" style="margin: auto; text-align: center">
                                    <div class="col-md-12" style="margin: auto">
                                        <button type="button" id="btn1" onclick="javascript:window.location = '/DirectMaterialPurchasingTypeRecord/DirectMaterialPurchasingTypeRecord'" style="text-align: center; margin-top: 0px;
                                            height: 30px; width: 20%; border-radius: 100px; font-size: 12px; background-color: #f5f5f5;
                                            border: 2px solid #c0c0c0; font-weight: bold" class="btn btn-default">
                                            返回上页</button>
                                    </div>
                                </div>
                            </form>
                    </div>
                  
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">
                    关闭
                </button> 
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal -->
</div> 
<div class="modal fade" id="ShowAddSubCategory" tabindex="-1" role="dialog" aria-labelledby="excelImportModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="excelImportModalLabel">
                    新增子类别
                </h4>
            </div>
            <div class="modal-body"> 
                <div class="row">
                    <div class="col-md-12" style="margin-bottom: 0px">
                          <form id="Add_Form" style="text-align: center;">
                                <div class="form-group">
                                    <div class="input-group " style="margin: 0">
                                        <span class="input-group-addon" style="color: #000000">&nbsp;&nbsp;类别名称&nbsp;&nbsp;&nbsp;</span>
                                        <select id="Currency" name="Currency" class="form-control" require="true">
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="input-group " style="margin: 0">
                                        <span class="input-group-addon" style="color: #000000">&nbsp;&nbsp;子类别名称&nbsp;&nbsp;&nbsp;</span>
                                        <input type="text" id="CategoryName" name="CategoryName" class="form-control" required=""/>
                                    </div>
                                </div>
                                <div class="form-group" style="margin: auto; text-align: center">
                                    <div class="col-md-12" style="margin: auto">
                                        <button type="button" id="btn1" onclick="Submit()" style="text-align: center; margin-top: 0px;
                                            height: 30px; width: 20%; border-radius: 100px; font-size: 12px; background-color: #f5f5f5;
                                            border: 2px solid #c0c0c0; font-weight: bold" class="btn btn-default">
                                            提交</button>
                                    </div>
                                </div>
                               <br />
                               <br />                         
                               <div class="form-group" style="margin: auto; text-align: center">
                <div class="col-md-12" style="margin: auto">
                    <button type="button" id="btn1" onclick="javascript:window.location = '/Common/Index'" style="text-align: center; margin-top: 0px;
                        height: 30px; width: 20%; border-radius: 100px; font-size: 12px; background-color: #f5f5f5;
                        border: 2px solid #c0c0c0; font-weight: bold" class="btn btn-default">
                        返回上页</button>
                </div>
            </div>
                            </form>
                    </div>
                  
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">
                    关闭
                </button> 
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal -->
</div> 
<script language="javascript" type="text/javascript">
    jQuery(document).ready(function () {
        $('#dataList').bootstrapTable({
            url: "/DirectMaterialPurchasingQuery/GetDirectMaterialPurchasingList",
            method: 'get',
            pageSize: 10,
            pageList: [10, 20, 50, 100, 200], // 自定义分页列表
            pageNumber: 1,
            singleSelect: true,
            clickToSelect: true,
            checkOnSelect: true,
            selectOnCheck: true,
            pagination: true,
            sortName: 'Name', // 设置默认排序为 name
            sortOrder: 'desc', // 设置排序为反序 desc
            search: false, // 开启搜索功能
            showColumns: false,
            showRefresh: false,
            showQuery: false,
            showToggle: false,
            showExport: false,
            exportTypes: ['xml', 'txt', 'excel'],
            columns: [[
				{ field: 'Date', title: '类别', formatter: DateHandle, remoteSort: true },
				{ field: 'Amount', title: '子类别', align: 'right', formatter: DecimalFmter },
				{ field: 'Currency', title: '备注' },
				{ field: 'RPerName', title: '供应商' },
                { field: 'InvType', title: '物料类别' },
                { field: 'A_GUID', title: '附件', align: 'center', formatter: FJHandle },
                { field: "State", title: "@General.Resource.Common.Flag" },
				{ field: 'Remark', title: '@General.Resource.Common.Remark ' },
				{ field: 'GUID', title: '', formatter: LinkHandle }
            ]],
            queryParams: queryParams
        });
        });
    function queryParams(params) {  //配置参数
        var temp = {   //这里的键的名字和控制器的变量名必须一直，这边改动，控制器也需要改成一样的
            pageSize: params.limit,   //页面大小
            pageIndex: params.pageNumber,  //页码
            dateBegin: $("#dateBegin").val(),
            dateEnd: $("#dateEnd").val(),
            customer: $("#customer").val(),
            grp: $("#incomeGrp").val(),
            state: $("#state").val()
        };
        return temp;
    }
    function ShowAddCategory() {
      $('#ShowAddCategory').modal({ show: true, backdrop: 'static' });
    }
    function ShowAddSubCategory() {
        $('#ShowAddSubCategory').modal({ show: true, backdrop: 'static' });
    }
</script>
<script language="javascript" type="text/javascript">



    function ChangeDateFormat(jsondate) {
        jsondate = jsondate.replace("/Date(", "").replace(")/", "");
        if (jsondate.indexOf("+") > 0) {
            jsondate = jsondate.substring(0, jsondate.indexOf("+"));
        }
        else if (jsondate.indexOf("-") > 0) {
            jsondate = jsondate.substring(0, jsondate.indexOf("-"));
        }

        var date = new Date(parseInt(jsondate, 10));
        var month = date.getMonth() + 1 < 10 ? "0" + (date.getMonth() + 1) : date.getMonth() + 1;
        var currentDate = date.getDate() < 10 ? "0" + date.getDate() : date.getDate();
        return date.getFullYear() + "-" + month + "-" + currentDate;
    }

    var DecimalFmter = function (s) {
        if (s == null || s == "undefined") {
            return "";
        }
        var h = '';
        s = s.toString();
        if (s.charAt(0) == '-') {
            h = '-';
            s = s.slice(1);
        }
        if (/[^0-9\.]/.test(s)) return "NaN";
        s = s.replace(/^(\d*)$/, "$1.");
        s = (s + "00").replace(/(\d*\.\d\d)\d*/, "$1");
        s = s.replace(".", ",");
        var re = /(\d)(\d{3},)/;
        while (re.test(s)) s = s.replace(re, "$1,$2");
        s = s.replace(/,(\d\d)$/, ".$1");
        return h + s.replace(/^\./, "0.");

    }

    var LinkHandle = function (value, row, index) {
        var link1;
        if (row.State == "存货") {
            link1 = " <a class='linkbtn' onclick='UsedClick(\"" + value + "\")'>编辑</a> ";
        } else if (row.State == "用完") {
            link1 = "";
        } else {
            link1 = "";
        }
        var link2;
        if (row.State == "存货") {
            link2 = " <a class='linkbtn' onclick='UsedClick(\"" + value + "\")'>使用</a> ";
        } else if (row.State == "用完") {
            link2 = "已使用";
        } else {
            link2 = "不可使用";
        }
        var link3;
        if (row.State == "存货") {
            link3 = " <a class='linkbtn' onclick='ResaleClick(\"" + value + "\")'>转售</a> ";
        } else if (row.State == "用完") {
            link3 = "不可转售";
        } else {
            link3 = "已转售";
        }
        var link4;
        if (row.State == "存货") {
            link4 = " <a class='linkbtn' onclick='UsedClick(\"" + value + "\")'>删除</a> ";
        } else if (row.State == "用完") {
            link4 = "";
        } else {
            link4 = "";
        }
        return link1 + link2 + link3 + link4;
    };

    var DateHandle = function (value, row, index) {
        if (value == "/Date(-62135596800000)/") {
            return "";
        } else {
            return ChangeDateFormat(value);
        }
    };
    var FJHandle = function (value, row, index) {
        if (value == "" || value == null) {
            return "";
        } else {
            var v = "../Content/EasyUI/themes/icons/hxz.png";
            return '<img style="height: 16px;width: 16px;" src="' + v + '" />';
        }
    };

    function query() {
        $('#dataList').bootstrapTable('refresh');
    }
</script>
  
<script language="javascript" type="text/javascript">
    $(function () {
        $('#editModal').on('hide.bs.modal', function () {
            $.ajax({
                url: "/DirectMaterialPurchasingQuery/DelPic/" + $('#picpath').val(),
                async: false,
                contentType: 'application/json',
                dataType: 'html',
                success: function (data) {
                },
                error: function (err) {
                    alert('hide' + err);
                }
            })
        })
    });


    function DownLoadFile(id) {
        $.ajax({
            url: "/DirectMaterialPurchasingQuery/DownLoadFile/" + id,
            async: false,
            contentType: 'application/json',
            dataType: 'html',
            success: function (data) {
                if (data == '') {
                    ShowFile('');
                } else {
                    ShowFile("<img src='/img/temp/" + data + "' class='file-preview-image' alt='Desert' title='Desert'>");
                    $('#picpath').val(data);
                    //alert(data);
                }
            },
            error: function (err) {
                alert(err);
            }
        })
    }
    function ShowFile(data) {
        $('#input-24').fileinput('destroy');
        FileInputBaseSetting("#input-24");
        $('#input-24').on('filecleared', function (event) {
            $("#changing").val('change');
            //alert('cleared');
        });
        $('#input-24').on('fileloaded', function (event, file, previewId, index, reader) {
            $("#changing").val('change');
            //alert('load');
        });
        $("#input-24").fileinput('refresh', {
            showPreview: true,
            initialPreviewCount: 1,
            showRemove: true,
            initialPreviewShowDelete: false,
            initialPreviewAsData: true,
            overwriteInitial: true,
            initialCaption: "文件不大于2M",
            uploadUrl: '/InternalAPI/FileUpload',
            allowedFileExtensions: ['jpg', 'png'],
            uploadExtraData: function () { // callback example
                var out = {};
                out['frGuid'] = $('#GUID').val();
                return out;
            },
            initialPreviewConfig: [
            {
                caption: 'desert.jpg',
                width: '120px',
                url: '/DirectMaterialPurchasingQuery/DelAttachment/' + $('#GUID').val(),
                key: 100,
                extra: { id: 100 },
                previewAsData: true
            }]
        });

        if (data != '') {
            $("#input-24").fileinput('refresh', {
                initialPreview: [data]
            });
        } else {
            $("#input-24").fileinput('refresh', {
                initialPreview: []
            });
        }

        $('#input-24').on('change', function (event) {
            $("#changing").val('change');
        });
    }

    function InitDialog() {
        $("#DirectMaterialPurchasing_List").after('<div id="WinIR"></div>');
        $("#WinIR").dialog({
            title: ' ',
            collapsible: false,
            minimizable: false,
            width: 800,
            height: 350,
            onClose: function () { $("#WinIR").dialog("destroy"); },
            buttons: [{
                text: '@General.Resource.Common.Save',
                handler: function () { SubmitForm(); }
            }]
        });
    }
    function InitDialogE() {
        $("#DirectMaterialPurchasing_List").after('<div id="WinER"></div>');
        $("#WinER").dialog({
            title: '记录营业成本',
            collapsible: false,
            minimizable: false,
            width: 800,
            height: 350,
            onClose: function () { $("#WinER").dialog("destroy"); },
            buttons: [{
                text: '@General.Resource.Common.Save',
                handler: function () { ESubmitForm(); }
            }]
        });
    }
    function InitDialogI() {
        $("#DirectMaterialPurchasing_List").after('<div id="WinR"></div>');
        $("#WinR").dialog({
            title: '记录营业外收入',
            collapsible: false,
            minimizable: false,
            width: 800,
            height: 350,
            onClose: function () { $("#WinR").dialog("destroy"); },
            buttons: [{
                text: '@General.Resource.Common.Save',
                handler: function () { ISubmitForm(); }
            }]
        });
    }

    var a = 2;
    function add(id) {
        var o = document.getElementById("PZ" + id);
        var div = document.createElement("div");
        div.id = "PZ" + id + "_" + a;
        div.className = "col-md-12";
        div.innerHTML = o.innerHTML.replace(/\{0\}/ig, a);
        document.getElementById("AddLayout" + id).appendChild(div);
        //为新增的file控件初始化
        IntiFileUpload('#' + div.id + " #certificate" + id, $('#IE_GUID' + id).val());
        a++;
    }

    //初始化fileinput控件（第一次初始化）

    function IntiFileUpload(selector, frguid) {

        FileInputBaseSetting(selector);
        $(selector).fileinput('refresh', {
            uploadUrl: '/InternalAPI/FileUpload',
            allowedFileExtensions: ['jpg', 'png', 'gif'],
            maxFileCount: 5,
            mainClass: "input-group-lg",
            browseClass: "btn bg-purple2 btn-sm",
            uploadExtraData: function () { // callback example
                var out = {};
                out['frGuid'] = frguid;
                return out;
            }
        });
    }

    //产生GUID
    function NewGUID() {
        var GUID;
        $.ajax({
            url: "/ReceivablesRecord/NewGuid",
            async: false,
            dataType: "text",
            success: function (d) {
                GUID = d.toString();
            }
        });
        return GUID;
    }


    function Edit(id) {
        $('#changing').val('');
        $.ajax({
            url: "/DirectMaterialPurchasingQuery/GetAIDRecord/" + id,
            async: false,
            contentType: 'application/json',
            dataType: 'html',
            success: function (data) {
                var obj = JSON.parse(data);

                $('#GUID').val(obj.GUID);
                $('#C_GUID').val(obj.C_GUID);
                $('#AID_Flag').val(obj.AID_Flag);
                $('#Remark').val(obj.Remark);
                $('#CostType').val(obj.CostType);
                $('#SurplusValue').val(obj.SurplusValue);
                $('#State').val(obj.State);
                $('#Date').val(ChangeDateFormat(obj.Date));
                $('#Amount').val(obj.Amount);
                $('#Currency').multiselect('select', obj.Currency);
                $('#RPer').multiselect('select', obj.RPer);
                $('#InvType').multiselect('select', obj.InvType);
                $('#Description').val(obj.Description);
                $('#DepreciationPeriod').val(obj.DepreciationPeriod);
                DownLoadFile(id)

            },
            error: function (err) {
                alert(err);

            }
        })

        $('#editModal').modal({ show: true, backdrop: 'static' });

    }
    function SaveChanges() {
        $.ajax({
            cache: true,
            type: "POST",
            url: "/DirectMaterialPurchasingQuery/UpdDirectMaterialPurchasingRecord",
            data: $('#D_Form').serialize(),
            async: false,
            onSubmit: function () {
                return $("#D_Form").form('validate');
            },
            error: function (request) {
                alert("Connection error");
            },
            success: function (data) {
                //提交成功
                if ($("#changing").val() == 'change') {
                    delAttach($('#GUID').val());
                    $("#input-24").each(function () {
                        $(this).fileinput('upload')
                    });
                }
                //              else {
                //                    alert('not changed');
                //                }

            }
        });
        $('#editModal').modal('hide');
        $('#dataList').bootstrapTable('refresh');
    }

    function delAttach(id) {
        $.ajax({
            url: "/DirectMaterialPurchasingQuery/DelAttachment/" + id,
            type: "POST",
            success: function (data) {
                $("#input-24").each(function () {
                    $(this).fileinput('upload')
                });
            },
            error: function () {
                alert('@General.Resource.Common.NoResponse');
            }
        });
    }

    function EditClick(id) {
        InitDialog();
        $('#WinIR').dialog("refresh", "/DirectMaterialPurchasingQuery/DirectMaterialPurchasingRecord/" + id);
        $('#myModal').modal({ show: true, backdrop: 'static' });
    }

    function Used(id) {
        clear(1);
        //初始化fileinput控件（第一次初始化）
        $('#tmpAID_GUID1').val(id);
        $('#IE_GUID1').val(id);
        $('#AffirmDate1').datepicker();
        $('#Date1').datepicker();
        IntiFileUpload("#PZ1_1 #certificate1", $('#IE_GUID1').val());
        parentaccGuid = '51BFDD3E-2253-4FBF-A946-19C18C25C6FC';
        showMadeInfomation(id);
        showIEGroup(parentaccGuid);
        $('#useModal').modal({ show: true, backdrop: 'static' });
    }

    function showMadeInfomation(id) {
        $.ajax({
            url: "/DirectMaterialPurchasingQuery/GetAIDRecord/" + id,
            async: false,
            contentType: 'application/json',
            dataType: 'html',
            success: function (data) {
                var obj = JSON.parse(data);
                $('#Remarkinfo').val(obj.Remark);
                $('#Amountinfo').val(obj.Amount);
                $('#Amountused').val(obj.Amount);
                $('#Currency1').multiselect('select', obj.Currency);
                $('#RPer1').multiselect('select', obj.RPer);
                $('#Descriptioninfo').val(obj.Description);
                DownLoadFile(id)
            },
            error: function (err) {
                alert(err);
            }
        })
        $('#TaxationType1').multiselect({
            buttonWidth: '100%',
            maxHeight: 200,
            enableFiltering: false,
            includeFilterNewBtn: false,
            includeSelectAllOption: true
        });

    }

    function showIEGroup() {
        $.ajax({
            url: "/InternalAPI/GetDetailType?coloum=" + "ExpenseFlag",
            async: false,
            dataType: "json",
            success: function (d) {
                $(".selectpicker").prepend("<option value=''>===请选择详细费用类别===</option>");
                for (var i = 0; i < d.length; i++) {

                    $(".selectpicker").append("<option value=" + d[i].value + ">" + d[i].label + "</option>");
                }
            },
            error: function (a, b, c) {

                alert(a);
            }
        });
        //         $("#IEGroup").multiselect('dataprovider', detailType);
        //         $("#IEGroup").val("").multiselect("refresh");
        $('.selectpicker').selectpicker('refresh');
    }

    function SaveChange() {
        var affirmDate = $("#AffirmDate1").val();
        var date = $("#Date1").val();
        if (affirmDate == "" || date == "") {
            alert("请选择费用确认日期和费用截止日期!");
        } else if (Date.parse(affirmDate) > Date.parse(date)) {
            alert("费用确认日期不能大于费用截止日期，请重新选择！");
        } else {
            $.ajax({
                cache: true,
                type: "POST",
                url: "/DirectMaterialPurchasingQuery/UpdExpenseRecord",
                data: $('#T_Form').serialize(),
                async: false,
                onSubmit: function () {
                    return $("#T_Form").form('validate');
                    // $('#aa').val('success');
                },
                error: function (request) {
                    alert("Connection error");
                    //$('#aa').val('error');
                },
                success: function (data) {
                    //提交成功
                    for (var i = 1; i < 20; i++) {
                        $('#PZ1_' + i + ' .file_upload').fileinput('upload');
                    }
                    $("[name=certificate1]").each(function () {
                        $(this).fileinput('upload')
                    })
                    clear();
                    ChangeStatus($('#tmpAID_GUID1').val(), '用完');
                    //这里应该是读取数据库中字段然后判断



                    $('#useModal').modal('hide');
                }

            });
        }
    }

    function UsedClick(index) {
        $("#DirectMaterialPurchasing_List").datagrid('selectRow', index);
        var row = $("#DirectMaterialPurchasing_List").datagrid('getSelected');
        InitDialogE();
        $('#WinER').dialog("refresh", "/DirectMaterialPurchasingQuery/ExpenseRecord?id=" + row.GUID + "&date=" + ChangeDateFormat(row.Date) + "&amount=" + row.Amount + "&rper=" + row.RPer + "&currency=" + row.Currency);
    }

    function ResaleClick(index) {
        $("#DirectMaterialPurchasing_List").datagrid('selectRow', index);
        var row = $("#DirectMaterialPurchasing_List").datagrid('getSelected');
        InitDialogI();
        $('#WinR').dialog("refresh", "/DirectMaterialPurchasingQuery/IncomeRecord?id=" + row.GUID + "&date=" + ChangeDateFormat(row.Date) + "&amount=" + row.Amount + "&rper=" + row.RPer + "&currency=" + row.Currency);
    }

    function Resale(id) {

        clear(2);
        $('#tmpAID_GUID2').val(id);
        $("#IE_GUID2").val(NewGUID());
        $('#ss').val("123");
        //初始化日期控件
        $('#AffirmDate2').datepicker();
        $('#Date2').datepicker();
        IntiFileUpload("#PZ2_1 #certificate2");
        showMadeInfomations(id);
        //跳转页面
        //window.location.href = '/IncomeRecord/Temporary?IsCustomer=1&addStyle=' + obj;
        window.location.href = '/IncomeRecord/Temporary?addStyle=3&cuid=' + id;

    }
    function showMadeInfomations(id) {
        $.ajax({
            url: "/DirectMaterialPurchasingQuery/GetAIDRecord/" + id,
            async: false,
            contentType: 'application/json',
            dataType: 'html',
            success: function (data) {
                var obj = JSON.parse(data);
                $('#Currency2').multiselect('select', obj.Currency);
                $('#RPer2').multiselect('select', obj.RPer);
                $('#Amountinfos').val(obj.Amount);
                $('#Amountinfosd').val(obj.Amount);
                DownLoadFile(id)
            },
            error: function (err) {
                alert(err);
            }
        })

    }

    function clear(id) {
        for (i = 2; i <= 20; i++) {
            $('#PZ_' + i).remove();
        }
        $('#Amount' + id).val("");
        $('#TaxationAmount' + id).val("");
        $('#SumAmount' + id).val("");
        $('#Remark' + id).val("");
        $('#IEDescription' + id).val("");
        $('#PZ' + id + '_1 #Pnumber' + id).val("");
        $('#PZ' + id + ' #Pnumber' + id).val("");
    }

    function Submit() {
        var files = $("#PZ_1 #certificate").fileinput('getFileStack');
        var affirmDate = $("#AffirmDate").val();
        var date = $("#Date2").val();
        if (Date.parse(affirmDate) > Date.parse(date)) {
            alert("收入确认日期不能大于账期截止日期，请重新选择！");
        } else {
            $.ajax({
                cache: true,
                type: "POST",
                url: "/DirectMaterialPurchasingQuery/UpdIncomeRecord",
                data: $('#Resale_Form').serialize(),
                async: false,
                onSubmit: function () {
                    return $("#Resale_Form").form('validate');
                },
                error: function (request) {
                    alert("Connection error");
                },
                success: function (data) {
                    //提交成功，开始上传附件

                    $("[name=certificate]").each(function () {
                        $(this).fileinput('upload')
                    })


                    ChangeStatus();
                }
            });
        }
    }

    function ResaleSubmit() {
        var affirmDate = $("#AffirmDate2").val();
        var date = $("#Date2").val();
        if (affirmDate == "" || date == "") {
            alert("请选择收入日期和截止日期!");
        } else if (Date.parse(affirmDate) > Date.parse(date)) {
            alert("收入确认日期不能大于账期截止日期，请重新选择！");
        } else {
            $.ajax({
                cache: true,
                type: "POST",
                url: "/DirectMaterialPurchasingQuery/UpdExpenseRecord",
                data: $('#Resale_Form').serialize(),
                async: false,
                onSubmit: function () {
                    return $("#Resale_Form").form('validate');
                },
                error: function (request) {
                    alert(request.toString());
                },
                success: function (data) {
                    //提交成功，开始上传附件
                    $("[name=certificate2]").each(function () {
                        $(this).fileinput('upload')
                    })
                    ChangeStatus($('#tmpAID_GUID2').val(), '转售');
                    $('#resaleModal').modal('hide');
                }
            });
        }
    }

    function ChangeStatus(guid, state) {

        //成功以后更改状态  
        $('#dataList').bootstrapTable('refresh');
        /*   $.ajax({
               cache: true,
               type: "POST",
               url: "/DirectMaterialPurchasingQuery/UpdDirectMaterialPurchasingRecordState?id=" + guid + "&state=" + state,
               async: false,
               onSubmit: function () {
               },
               error: function (request) {
                   alert("Update Error");
               },
               success: function (data) {
                   //location.reload(true);
                 
                   //$("input[type=reset]").trigger("click");//清空表单内容
               }
           });*/
    }

    function DelClick(id) {
        if (confirm('确认删除?')) {
            $.ajax({
                url: "/DirectMaterialPurchasingQuery/DelDirectMaterialPurchasingRecord/" + id,
                type: "POST",
                success: function (data) {
                    var res = JSON.parse(data);
                    alert(res.Msg);
                    query();
                },
                error: function () {
                    alert('@General.Resource.Common.NoResponse');
                }
            });
        }
    };
    function SubmitForm() {
        $("#IMP_Form").form('submit', {
            url: "/DirectMaterialPurchasingQuery/UpdDirectMaterialPurchasingRecord",
            onSubmit: function () {
                if ($("#IMP_Form").form("validate")) {
                    $('#file_upload').uploadify('upload', '*');
                }
            },
            success: function (data) {
                $.messager.alert('Message', $.parseJSON(data).Msg, 'info', function () {
                    $("#DirectMaterialPurchasing_List").datagrid("reload");
                });
                if ($.parseJSON(data).Result) {
                    $('#WinIR').dialog("close");
                }
            }
        });
    }

    function ESubmitForm() {
        var row = $("#DirectMaterialPurchasing_List").datagrid('getSelected');
        $("#Expense_Form").form('submit', {
            url: "/ExpenseRecord/UpdExpenseRecord",
            onSubmit: function () {
                if ($("#Expense_Form").form("validate")) {
                    $('#file_upload').uploadify('upload', '*');
                }
                return $("#Income_Form").form("validate");
            },
            success: function (data) {
                $.messager.alert('Message', $.parseJSON(data).Msg, 'info', function () {
                    $.ajax({
                        url: "/DirectMaterialPurchasingQuery/UpdDirectMaterialPurchasingRecordState?id=" + row.GUID + "&state=用完",
                        type: "POST",
                        success: function (data) {
                            if ($.parseJSON(data).Result) {
                                $('#DirectMaterialPurchasing_List').datagrid("reload");
                            }
                        }
                    });
                });
                if ($.parseJSON(data).Result) {
                    $('#WinER').dialog("close");
                }
            }
        });
    }
    function ISubmitForm() {
        var row = $("#DirectMaterialPurchasing_List").datagrid('getSelected');
        $("#Income_Form").form('submit', {
            url: "/IncomeRecord/UpdIncomeRecord",
            onSubmit: function () {
                if ($("#Income_Form").form("validate")) {
                    $('#file_upload').uploadify('upload', '*');
                }
                return $("#Income_Form").form("validate");
            },
            success: function (data) {
                $.messager.alert('Message', $.parseJSON(data).Msg, 'info', function () {
                    $.ajax({
                        url: "/DirectMaterialPurchasingQuery/UpdDirectMaterialPurchasingRecordState?id=" + row.GUID + "&state=转售",
                        type: "POST",
                        success: function (data) {
                            if ($.parseJSON(data).Result) {
                                $('#DirectMaterialPurchasing_List').datagrid("reload");
                            }
                        }
                    });
                });
                if ($.parseJSON(data).Result) {
                    $('#WinR').dialog("close");
                }
            }
        });
    }

    function Search() {
        $("#DirectMaterialPurchasing_List").datagrid("load", $("#conditionForm").serializeObject());
    }

    function Export() {
        $("#conditionForm").form("submit", { url: '/IncomeQuery/ExportXls' });
    }

    function compute() {
        var rows = $('#DirectMaterialPurchasing_List').datagrid('getRows'); //获取当前的数据行
        var totalsumamount = 0;
        for (var i = 0; i < rows.length; i++) {
            totalsumamount += rows[i]['Amount'];
        }
        var p = $('#DirectMaterialPurchasing_List').datagrid('getPager');
        $(p).pagination({
            displayMsg: '当前' + rows.length + '条记录总金额为{ ' + Money(totalsumamount) + ' }'
        });
    }
    function checkAmount() {
        var amount = document.getElementById('Amountinfo').value == '' ? 0 : document.getElementById('Amountinfo').value;
        var taxationamount = document.getElementById('TaxationAmount').value == '' ? 0 : document.getElementById('TaxationAmount').value;
        amount = amount.replace(/,/g, "");
        taxationamount = taxationamount.replace(/,/g, "");
        document.getElementById('SumAmount').value = Money(parseFloat(amount) + parseFloat(taxationamount));
    }
    function checkAmounts() {
        var amount = document.getElementById('Amountinfos').value == '' ? 0 : document.getElementById('Amountinfos').value;
        var taxationamount = document.getElementById('TaxationAmounts').value == '' ? 0 : document.getElementById('TaxationAmounts').value;
        amount = amount.replace(/,/g, "");
        taxationamount = taxationamount.replace(/,/g, "");
        document.getElementById('SumAmounts').value = Money(parseFloat(amount) + parseFloat(taxationamount));
    }

    function Money(price) {
        if (price > 0) { var priceString = price.toString(); var priceInt = parseInt(price); var len = priceInt.toString().length; var num = len / 3; var remainder = len % 3; var priceStr = ''; for (var i = 1; i <= len; i++) { priceStr += priceString.charAt(i - 1); if (i == (remainder) && len > remainder) priceStr += ','; if ((i - remainder) % 3 == 0 && i < len && i > remainder) priceStr += ','; } if (priceString.indexOf('.') < 0) { priceStr = priceStr + '.00'; } else { priceStr += priceString.substr(priceString.indexOf('.')); if (priceString.length - priceString.indexOf('.') - 1 < 2) { priceStr = priceStr + '0'; } } return priceStr; } else { return price; }
    }


    function AddCustomer(obj) {

        var c_AffirmDate = $('#AffirmDate').val();
        var c_Date = $('#Date').val();
        var c_Amount = $('#Amount').val();
        var c_Currency = $('#Currency').val();
        var c_TaxationType = $('#TaxationType').val();
        var c_TaxationAmount = $('#TaxationAmount').val();
        var c_SumAmount = $('#SumAmount').val();
        var c_Remark = $('#Remark').val();
        var c_InvNo = $('#InvNo').val();
        var c_InvType = $('#InvType').val();
        var c_IE_GUID = $('#IE_GUID').val();
        var c_State = $('#State').val();
        var c_SumAmount1 = $('#SumAmount1').val();
        var c_TaxationAmount1 = $('#TaxationAmount1').val();
        var c_Amount1 = $('#Amount1').val();

        $.cookie('c_AffirmDate', c_AffirmDate, { expires: 7 }); // 存储 cookie 
        $.cookie('c_Date', c_Date, { expires: 7 }); // 存储 cookie 
        $.cookie('c_Amount', c_Amount, { expires: 7 }); // 存储 cookie 
        $.cookie('c_Currency', c_Currency, { expires: 7 }); // 存储 cookie 
        $.cookie('c_TaxationType', c_TaxationType, { expires: 7 }); // 存储 cookie 
        $.cookie('c_TaxationAmount', c_TaxationAmount, { expires: 7 }); // 存储 cookie 
        $.cookie('c_SumAmount', c_SumAmount, { expires: 7 }); // 存储 cookie 
        $.cookie('c_Remark', c_Remark, { expires: 7 }); // 存储 cookie 
        $.cookie('c_InvNo', c_InvNo, { expires: 7 }); // 存储 cookie 
        $.cookie('c_IE_GUID', c_IE_GUID, { expires: 7 }); // 存储 cookie 
        $.cookie('c_State', c_State, { expires: 7 }); // 存储 cookie 
        window.location.href = '/BusinessPartnerSetting/BusinessPartner?IsCustomer=1&addStyle=' + obj;
    }
    function SubmitCustomerForm() {
        $('#BP_GUID').val(NewGUID());
        $.ajax({
            cache: true,
            type: "POST",
            url: "/ExpenseRecord/UpdSupplier",
            data: $('#Customer_Form').serialize(),
            async: false,
            onSubmit: function () {
                return $("#Customer_Form").form('validate');
            },
            error: function (request) {
                alert("Connection error");
            },
            success: function (data) {
                //提交成功
                $('#myModal').modal('hide');
                alert("新供应商登记成功！");

            }
        });
    }
    function ShowModel(obj) {
        var url;
        var columns = new Array();

        columns.push({ field: 'ck', checkbox: true, title: '选择', width: '50' });

        if (obj.id == "btnPayeable") {
            url = '/PaymentRecord/GetChoosePayablesRecord/';
            columns.push({ field: 'RPerName', title: '@FMS.Resource.Finance.Finance.Payee', align: 'center' });
            columns.push({ field: 'InvNo', title: '@FMS.Resource.Finance.Finance.InvNo', align: 'center' });
            columns.push({ field: 'InvType', title: '收入类别', align: 'center' });
            columns.push({ field: 'AffirmDate', title: '@FMS.Resource.Finance.Finance.Proceeds@FMS.Resource.Finance.Finance.AffirmDate', align: 'center', formatter: DateHandle });
            columns.push({ field: 'Money', title: '@FMS.Resource.Finance.Finance.Proceeds@FMS.Resource.Finance.Finance.Amount', align: 'center', formatter: DecimalFmter });

        } else if (obj.id == "btnCostOut") {
            url = '/PaymentDeclareCostSpending/GetPaymentDeclareCostSpendingList?invtype=' + escape('预付供应商') + "&record=" + escape('未记录');
            //             url = '/PaymentDeclareCostSpending/GetPaymentDeclareCostSpendingList?state='+escape('已付')+ "&invtype=" + escape('预付供应商');
            columns.push({ field: 'Date', title: '申报日期', formatter: DateHandle });
            columns.push({ field: 'VoucherNo', title: '@FMS.Resource.Finance.Finance.InvNo', align: 'center' });
            columns.push({ field: 'RPerName', title: '收款方' });
            columns.push({ field: 'Amount', title: '申报金额', align: 'center', formatter: DecimalFmter });
            columns.push({ field: 'Currency', title: '货币' });
            columns.push({ field: "InvType", title: '收款类别' });
            columns.push({ field: 'Remark', title: '备注' });
            columns.push({ field: 'AGUID', title: '附件', align: 'center', formatter: FJHandle }),
            columns.push({ field: 'State', title: '状态', align: 'center' });

        }
        else if (obj.id == "btnSalary") {
            url = '/PaymentRecord/GetChoosePayablesRecord?iegroup=1544d862-b1ab-42b8-9e97-9c2e1704665c';

            columns.push({ field: 'RPerName', title: '@FMS.Resource.Finance.Finance.Payee', width: 70, align: 'center' });
            columns.push({ field: 'InvNo', title: '@FMS.Resource.Finance.Finance.InvNo', width: '120', align: 'center' });
            columns.push({ field: 'InvType', title: '费用类别', width: 100, align: 'center' });
            columns.push({ field: 'IEGroupName', title: '费用详细类别', width: 130, align: 'center' });
            columns.push({ field: 'AffirmDate', title: '@FMS.Resource.Finance.Finance.Expense@FMS.Resource.Finance.Finance.AffirmDate', width: '110', align: 'center', formatter: ChangeDateFormat });
            columns.push({ field: 'Money', title: '@FMS.Resource.Finance.Finance.Amount', width: 70, align: 'center', formatter: DecimalFmter });
            columns.push({ field: 'Remark', title: '备注', width: 100, align: 'center' });
        }

    $("#actionHandler").val(obj.id);

    $('#aTable').bootstrapTable({
        url: url,
        method: 'get',
        pageSize: 5,
        pageList: [5, 10, 25, 50, 100, 200], // 自定义分页列表
        pageNumber: 1,
        clickToSelect: true,
        checkOnSelect: true,
        selectOnCheck: true,
        pagination: true,
        sortName: 'AffirmDate', // 设置默认排序为 name
        sortOrder: 'desc', // 设置排序为反序 desc
        search: false,
        showColumns: true,
        showRefresh: false,
        showQuery: false,
        showToggle: false,
        showExport: false,
        exportTypes: ['excel'],
        columns: columns
    });
    $('#amyModal').modal({ show: true, backdrop: 'static' });
}
</script>

